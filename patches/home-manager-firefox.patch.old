From 0f201853095065997deb5f0d64a8b24a80546710 Mon Sep 17 00:00:00 2001
From: liuwilli <liuwilli@protonmail.com>
Date: Thu, 11 Jul 2024 12:46:26 -0400
Subject: [PATCH] firefox: add extraConfigEarly

---
 modules/programs/firefox.nix | 15 +++++++++++++--
 1 file changed, 13 insertions(+), 2 deletions(-)

diff --git a/modules/programs/firefox.nix b/modules/programs/firefox.nix
index 1370d4c2..369c9acf 100644
--- a/modules/programs/firefox.nix
+++ b/modules/programs/firefox.nix
@@ -60,7 +60,7 @@ let
     else
       builtins.toJSON pref);
 
-  mkUserJs = prefs: extraPrefs: bookmarks:
+  mkUserJs = extraPrefsEarly: prefs: extraPrefs: bookmarks:
     let
       prefs' = lib.optionalAttrs ([ ] != bookmarks) {
         "browser.bookmarks.file" = toString (firefoxBookmarksFile bookmarks);
@@ -69,6 +69,8 @@ let
     in ''
       // Generated by Home Manager.
 
+      ${extraPrefsEarly}
+
       ${concatStrings (mapAttrsToList (name: value: ''
         user_pref("${name}", ${userPrefValue value});
       '') prefs')}
@@ -342,6 +344,14 @@ in {
               '';
             };
 
+            extraConfigEarly = mkOption {
+              type = types.lines;
+              default = "";
+              description = ''
+                Like extraConfig, except lines are added to {file}`user.js` before all other configuration.
+              '';
+            };
+
             userChrome = mkOption {
               type = types.lines;
               default = "";
@@ -771,9 +781,10 @@ in {
         mkIf (profile.userContent != "") { text = profile.userContent; };
 
       "${profilesPath}/${profile.path}/user.js" = mkIf (profile.settings != { }
+        || profile.extraConfigEarly != ""
         || profile.extraConfig != "" || profile.bookmarks != [ ]) {
           text =
-            mkUserJs profile.settings profile.extraConfig profile.bookmarks;
+            mkUserJs profile.extraConfigEarly profile.settings profile.extraConfig profile.bookmarks;
         };
 
       "${profilesPath}/${profile.path}/containers.json" =
-- 
2.45.1

